<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Warehouse — Employee</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#f6f7fb; color:#111; }
    header { background:#0b1b3a; color:#fff; padding:14px 18px; }
    header .top { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    header h1 { margin:0; font-size:18px; }
    header .me { font-size:13px; opacity:.92; }
    header button { background:#ffffff22; color:#fff; border:1px solid #ffffff33; padding:8px 10px; border-radius:10px; cursor:pointer; }
    main { max-width: 1100px; margin: 18px auto; padding: 0 16px 28px; display:grid; gap:16px; }
    .card { background:#fff; border-radius:14px; padding:14px; box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    h2 { margin:0 0 10px; font-size:16px; }
    .muted { color:#555; font-size:13px; line-height:1.35; }
    .msg { margin-top:10px; font-size:13px; }
    .err { color:#b42318; }
    .ok { color:#067647; }

    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }

    label { display:block; font-size:13px; margin:10px 0 6px; color:#222; }
    input, select, textarea { width:100%; padding:10px 12px; border:1px solid #d6d8e0; border-radius:10px; font-size:14px; box-sizing:border-box; }
    textarea { min-height: 90px; resize: vertical; }
    button.primary { background:#1f6feb; color:#fff; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; }
    button.ghost { background:transparent; color:#1f6feb; border:1px solid #cfe0ff; padding:10px 12px; border-radius:10px; cursor:pointer; }
    button.small { padding:6px 10px; border-radius:9px; font-size:13px; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid #eceef3; font-size:13px; vertical-align: top; }
    th { font-size:12px; color:#555; text-transform: uppercase; letter-spacing:.03em; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .nowrap { white-space:nowrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right { text-align:right; }
    .tiny { font-size:12px; opacity:.9; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; background:#eef2ff; border:1px solid #dbe4ff; font-size:12px; color:#1f3fbf; }

    /* GLOBAL floating dropdown (NOT inside table, so it won't be clipped) */
    .global-dropdown {
      position:absolute;
      z-index: 9999;
      background:#fff;
      border:1px solid #d6d8e0;
      border-radius:12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.12);
      max-height: 260px;
      overflow:auto;
      display:none;
      min-width: 220px;
    }
    .global-dropdown .suggestItem {
      padding:10px 12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:4px;
      border-bottom:1px solid #f0f2f7;
    }
    .global-dropdown .suggestItem:last-child { border-bottom:0; }
    .global-dropdown .suggestItem:hover { background:#f3f6ff; }
    .global-dropdown .suggestItem.active { background:#eef2ff; }
    .global-dropdown .suggestTop { display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
    .global-dropdown .suggestDesc { font-weight:600; }
    .global-dropdown .suggestMeta { font-size:12px; color:#666; }
    .global-dropdown .suggestCode { font-size:12px; color:#1f3fbf; }
  </style>
</head>
<body>
  <header>
    <div class="top">
      <div>
        <h1>Employee Dashboard</h1>
        <div class="me" id="meLine">Loading session…</div>
      </div>
      <div class="actions">
        <button id="btnRefreshConfig">Refresh</button>
        <button id="btnLogout">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Pallet editor -->
    <div class="card">
      <h2>Pallet Editor</h2>
      <div class="muted">
        Load pallet header via <code>GET /public/pallets/:pallet</code>, edit items, and save via
        <code>POST /employee/pallets/:pallet/save</code>.
        <br><span class="tiny">Description supports catalog suggestions (floating dropdown). Item No + BPC are visually autofilled, and BPC saves update the table immediately + won’t reprompt later.</span>
      </div>

      <div class="row" style="margin-top:12px;">
        <div>
          <label>Pallet # <span class="tiny" id="palletMaxNote"></span></label>
          <input id="palletNo" inputmode="numeric" placeholder="e.g. 12" />
        </div>
        <div>
          <label>Saved By (optional)</label>
          <input id="savedBy" placeholder="defaults to your username" />
        </div>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button class="primary" id="btnLoadPallet" type="button">Load pallet</button>
        <button class="ghost" id="btnAddRow" type="button">Add row</button>
        <button class="ghost" id="btnClearRows" type="button">Clear rows</button>
        <span class="badge" id="revBadge">rev: —</span>
      </div>

      <div id="palletMsg" class="msg"></div>

      <div style="overflow:auto; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th style="min-width:110px;">Item No</th>
              <th style="min-width:360px;">Description</th>
              <th class="right" style="min-width:70px;">BPC</th>
              <th class="right" style="min-width:70px;">Cases</th>
              <th class="right" style="min-width:70px;">Each</th>
              <th class="right" style="min-width:90px;">Units</th>
              <th class="nowrap">Actions</th>
            </tr>
          </thead>
          <tbody id="itemsTbody">
            <tr><td colspan="7" class="muted">Load a pallet to begin.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="primary" id="btnSavePallet" type="button">Save pallet</button>
        <div class="muted" id="unitsSummary"></div>
      </div>
    </div>

    <!-- Bulk clear -->
    <div class="card">
      <h2>Bulk Clear Pallets</h2>
      <div class="muted">
        Clears pallets via <code>POST /employee/pallets/clear</code>.
        You can paste ranges like <span class="mono">1-10, 12, 15-18</span>.
      </div>

      <label>Pallets (comma + ranges)</label>
      <textarea id="clearText" placeholder="e.g. 1-5, 7, 12-14"></textarea>

      <label>Saved By (optional)</label>
      <input id="clearSavedBy" placeholder="defaults to your username" />

      <div class="actions" style="margin-top:10px;">
        <button class="primary" id="btnBulkClear" type="button">Clear pallets</button>
        <button class="ghost" id="btnClearBulkBox" type="button">Clear box</button>
      </div>

      <div id="clearMsg" class="msg"></div>

      <div style="overflow:auto; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th class="right">Pallet</th>
              <th>Result</th>
              <th class="right">Rev</th>
              <th>Saved At</th>
              <th>Saved By</th>
              <th>Detail</th>
            </tr>
          </thead>
          <tbody id="clearTbody">
            <tr><td colspan="6" class="muted">No clears run yet.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Global floating dropdown lives OUTSIDE the table -->
  <div id="globalDropdown" class="global-dropdown" aria-hidden="true"></div>

<script>
  // ====== CONFIG ======
  const API_BASE = "https://queensims.anthonycr2001.workers.dev"; // <-- your Worker

  // Requires Worker routes:
  // GET  /catalog/search?q=...&limit=10        -> { ok:true, results:[{ itemNo, description }] }
  // GET  /bpc-overrides/get?itemNo=...         -> { ok:true, found:true|false, bpc?:number }
  // POST /bpc-overrides/upsert                 -> { ok:true } body { itemNo, bpc }

  // ====== helpers ======
  const $ = (id) => document.getElementById(id);
  const setMsg = (el, text, ok=false) => { el.textContent = text || ""; el.className = "msg " + (ok ? "ok" : "err"); };
  const esc = (s) => String(s ?? "");
  const boolStr = (v) => String(v||"").toLowerCase() === "true" ? "true" : "false";

  async function api(path, { method="GET", body=null } = {}) {
    const res = await fetch(API_BASE + path, {
      method,
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: body ? JSON.stringify(body) : null
    });
    const data = await res.json().catch(() => ({}));
    return { status: res.status, data };
  }

  function setBusy(btn, busy, busyText="Working…") {
    if (!btn) return;
    btn.disabled = !!busy;
    const orig = btn.getAttribute("data-orig") || btn.textContent;
    if (!btn.getAttribute("data-orig")) btn.setAttribute("data-orig", orig);
    btn.textContent = busy ? busyText : orig;
  }

  function isLastRow(tr) {
    const rows = Array.from($("itemsTbody").querySelectorAll("tr[data-idx]"));
    if (!rows.length) return false;
    return rows[rows.length - 1] === tr;
  }

  function isRowBlank(tr) {
    const itemNo = tr.querySelector(".i_itemNo")?.value?.trim() || "";
    const desc = tr.querySelector(".i_desc")?.value?.trim() || "";
    const cases = tr.querySelector(".i_cases")?.value?.trim() || "";
    const each = tr.querySelector(".i_each")?.value?.trim() || "";
    return !itemNo && !desc && !cases && !each;
  }

  // Only auto-add when they finish description AND it has a real itemNo
  function isRowReadyToCommit(tr) {
    const itemNo = tr.querySelector(".i_itemNo")?.value?.trim() || "";
    const desc = tr.querySelector(".i_desc")?.value?.trim() || "";
    return !!itemNo && !!desc;
  }

  // ====== session guard ======
  let ME = null;
  let PALLET_COUNT = null;

  async function guardEmployee() {
    const { data } = await api("/me");
    if (!data?.ok) { location.href = "./index.html"; return null; }

    const me = data.me || {};
    if (boolStr(me.mustChangePassword) === "true") {
      location.href = "./index.html";
      return null;
    }

    $("meLine").textContent = `Signed in as ${me.username} (${me.role})`;
    return me;
  }

  async function loadConfig() {
    const { data } = await api("/public/config");
    if (data?.ok && Number.isFinite(Number(data.palletCount))) {
      PALLET_COUNT = Number(data.palletCount);
      $("palletMaxNote").textContent = PALLET_COUNT ? `(max ${PALLET_COUNT})` : "";
    } else {
      PALLET_COUNT = null;
      $("palletMaxNote").textContent = "";
    }
  }

  // ====== pallet items table ======
  let CURRENT_PALLET = null;
  let CURRENT_REV = null;

  function computeUnits(bpc, cases, each) {
    const B = Number(bpc); const C = Number(cases); const E = Number(each);
    const bb = Number.isFinite(B) ? Math.trunc(B) : 0;
    const cc = Number.isFinite(C) ? Math.trunc(C) : 0;
    const ee = Number.isFinite(E) ? Math.trunc(E) : 0;
    if (bb < 1 || cc < 0 || ee < 0) return 0;
    return bb * cc + ee;
  }

  function updateUnitsSummary() {
    const rows = Array.from($("itemsTbody").querySelectorAll("tr[data-idx]"));
    let total = 0;

    for (const r of rows) {
      const bpc = Math.trunc(Number(r.querySelector(".i_bpc")?.value || "0"));
      const cases = Math.trunc(Number(r.querySelector(".i_cases")?.value || "0"));
      const each = Math.trunc(Number(r.querySelector(".i_each")?.value || "0"));
      const u = computeUnits(bpc, cases, each);
      const span = r.querySelector(".i_units");
      if (span) span.textContent = String(u);
      total += u;
    }
    $("unitsSummary").textContent = `Total units: ${total}`;
  }

  function getItemsFromUI() {
    const rows = Array.from($("itemsTbody").querySelectorAll("tr[data-idx]"));
    const out = [];
    for (const r of rows) {
      const itemNo = r.querySelector(".i_itemNo")?.value?.trim() || "";
      if (!itemNo) continue;

      const description = r.querySelector(".i_desc")?.value || "";
      const bpc = Math.trunc(Number(r.querySelector(".i_bpc")?.value || "0"));
      const cases = Math.trunc(Number(r.querySelector(".i_cases")?.value || "0"));
      const each = Math.trunc(Number(r.querySelector(".i_each")?.value || "0"));

      out.push({ itemNo, description, bpc, cases, each });
    }
    return out;
  }

  function renderItems(items) {
    const tbody = $("itemsTbody");
    const list = Array.isArray(items) ? items : [];

    if (!CURRENT_PALLET) {
      tbody.innerHTML = `<tr><td colspan="7" class="muted">Load a pallet to begin.</td></tr>`;
      $("unitsSummary").textContent = "";
      return;
    }

    const safe = list.length ? list : [];
    tbody.innerHTML = safe.map((it, idx) => {
      const itemNo = esc(it.itemNo || "");
      const description = esc(it.description || "");
      const bpc = Number.isFinite(Number(it.bpc)) ? Math.trunc(Number(it.bpc)) : 1;
      const cases = Number.isFinite(Number(it.cases)) ? Math.trunc(Number(it.cases)) : 0;
      const each = Number.isFinite(Number(it.each)) ? Math.trunc(Number(it.each)) : 0;
      const units = computeUnits(bpc, cases, each);

      return `
        <tr data-idx="${idx}">
          <td><input class="i_itemNo" value="${itemNo}" placeholder="Item No" /></td>
          <td><input class="i_desc" value="${description}" placeholder="Search description…" autocomplete="off" /></td>
          <td><input class="i_bpc right" inputmode="numeric" value="${bpc}" /></td>
          <td><input class="i_cases right" inputmode="numeric" value="${cases}" /></td>
          <td><input class="i_each right" inputmode="numeric" value="${each}" /></td>
          <td class="right"><span class="i_units">${units}</span></td>
          <td class="nowrap">
            <button class="ghost small" data-act="delRow">Delete</button>
          </td>
        </tr>
      `;
    }).join("");

    if (!safe.length) {
      tbody.innerHTML = `<tr><td colspan="7" class="muted">No items yet. Add a row.</td></tr>`;
      $("unitsSummary").textContent = "Total units: 0";
      return;
    }

    updateUnitsSummary();
  }

  function addBlankRow({ focusDesc=true } = {}) {
    const items = getItemsFromUI();
    items.push({ itemNo:"", description:"", bpc: 1, cases: 0, each: 0 });
    renderItems(items);
    const rows = Array.from($("itemsTbody").querySelectorAll("tr[data-idx]"));
    const last = rows[rows.length - 1];
    if (focusDesc) last?.querySelector(".i_desc")?.focus();
  }

  // ====== pallet load/save ======
  async function loadPallet() {
    const btn = $("btnLoadPallet");
    setBusy(btn, true, "Loading…");
    setMsg($("palletMsg"), "", true);

    try {
      const pallet = Math.trunc(Number($("palletNo").value || "0"));
      if (!Number.isInteger(pallet) || pallet < 1) {
        setMsg($("palletMsg"), "Enter a valid pallet number (>= 1).", false);
        return;
      }
      if (PALLET_COUNT && pallet > PALLET_COUNT) {
        setMsg($("palletMsg"), `Pallet out of range (max ${PALLET_COUNT}).`, false);
        return;
      }

      const { data } = await api(`/public/pallets/${pallet}`);
      if (!data?.ok) {
        setMsg($("palletMsg"), data?.error || "LOAD_FAILED", false);
        return;
      }

      CURRENT_PALLET = pallet;
      CURRENT_REV = Number.isFinite(Number(data.rev)) ? Math.trunc(Number(data.rev)) : 0;
      $("revBadge").textContent = `rev: ${CURRENT_REV}`;

      const items = Array.isArray(data.items) ? data.items : [];
      const initial = items.length ? items : [{ itemNo:"", description:"", bpc: 1, cases: 0, each: 0 }];
      renderItems(initial);

      setMsg($("palletMsg"), `Loaded pallet ${pallet} (rev ${CURRENT_REV}).`, true);
    } finally {
      setBusy(btn, false);
    }
  }

  async function savePallet() {
    const btn = $("btnSavePallet");
    setBusy(btn, true, "Saving…");
    setMsg($("palletMsg"), "", true);

    try {
      if (!CURRENT_PALLET) {
        setMsg($("palletMsg"), "Load a pallet first.", false);
        return;
      }
      if (!Number.isInteger(CURRENT_REV) || CURRENT_REV < 0) {
        setMsg($("palletMsg"), "Missing base revision. Reload the pallet.", false);
        return;
      }

      const items = getItemsFromUI();
      const savedBy = ($("savedBy").value.trim() || (ME?.username || "")).trim();

      const { data } = await api(`/employee/pallets/${CURRENT_PALLET}/save`, {
        method: "POST",
        body: { baseRev: CURRENT_REV, savedBy, items }
      });

      if (!data?.ok) {
        if (data?.error === "REV_CONFLICT") {
          setMsg($("palletMsg"), "REV_CONFLICT: Someone saved before you. Reload pallet and try again.", false);
          return;
        }
        setMsg($("palletMsg"), data?.error || "SAVE_FAILED", false);
        return;
      }

      if (Number.isFinite(Number(data.rev))) {
        CURRENT_REV = Math.trunc(Number(data.rev));
        $("revBadge").textContent = `rev: ${CURRENT_REV}`;
      }

      setMsg($("palletMsg"), "Saved successfully.", true);
    } finally {
      setBusy(btn, false);
    }
  }

  // ====== Catalog + BPC override logic ======
  // In-page cache so you don't get prompted again in this session
  const BPC_CACHE = new Map(); // itemNo -> bpc

  function setBpcEverywhere(itemNo, bpc) {
    const want = String(itemNo || "").trim();
    const val = Math.trunc(Number(bpc));
    if (!want || !Number.isFinite(val) || val < 1) return;

    const rows = Array.from($("itemsTbody").querySelectorAll("tr[data-idx]"));
    for (const r of rows) {
      const ino = r.querySelector(".i_itemNo")?.value?.trim() || "";
      if (ino === want) {
        const bpcInput = r.querySelector(".i_bpc");
        if (bpcInput) bpcInput.value = String(val);
      }
    }
    updateUnitsSummary();
  }

  async function searchCatalog(q) {
    const qq = String(q || "").trim();
    if (qq.length < 2) return [];
    const { data } = await api(`/catalog/search?q=${encodeURIComponent(qq)}&limit=10`);
    if (!data?.ok) return [];
    return Array.isArray(data.results) ? data.results : [];
  }

  async function getBpcOverride(itemNo) {
    const key = String(itemNo || "").trim();
    if (!key) return { ok:false, found:false };

    if (BPC_CACHE.has(key)) {
      return { ok:true, found:true, bpc: BPC_CACHE.get(key) };
    }

    const { data } = await api(`/bpc-overrides/get?itemNo=${encodeURIComponent(key)}`);
    if (!data?.ok) return { ok:false, found:false };

    const found = !!data.found;
    const bpc = Number(data.bpc);

    if (found && Number.isFinite(bpc) && Math.trunc(bpc) >= 1) {
      const v = Math.trunc(bpc);
      BPC_CACHE.set(key, v);
      return { ok:true, found:true, bpc: v };
    }

    return { ok:true, found:false };
  }

  async function upsertBpcOverride(itemNo, bpc) {
    const key = String(itemNo || "").trim();
    const val = Math.trunc(Number(bpc));
    if (!key || !Number.isFinite(val) || val < 1) return false;

    const { data } = await api(`/bpc-overrides/upsert`, { method:"POST", body:{ itemNo: key, bpc: val } });
    if (!data?.ok) return false;

    // Cache it + update any rows currently showing this item
    BPC_CACHE.set(key, val);
    setBpcEverywhere(key, val);
    return true;
  }

  function normalizeBpcInput(v) {
    const n = Math.trunc(Number(v));
    if (!Number.isFinite(n) || n < 1) return null;
    return n;
  }

  async function ensureBpcForItem(itemNo) {
    const key = String(itemNo || "").trim();
    if (!key) return false;

    const o = await getBpcOverride(key);
    if (o.ok && o.found && Number.isFinite(Number(o.bpc))) {
      const v = Math.trunc(Number(o.bpc));
      BPC_CACHE.set(key, v);
      setBpcEverywhere(key, v);
      return true;
    }

    const entered = prompt(`BPC not found for Item No ${key}.\n\nPlease enter BPC (bottles per case):`, "12");
    if (!entered) return false;

    const bpc = normalizeBpcInput(entered);
    if (!bpc) {
      alert("Invalid BPC. Must be a whole number >= 1.");
      return false;
    }

    const ok = await upsertBpcOverride(key, bpc);
    if (!ok) {
      alert("Could not save BPC override. Try again or contact manager.");
      return false;
    }

    return true;
  }

  // ====== Global dropdown (floating) ======
  const DD = $("globalDropdown");
  const ddState = {
    open: false,
    anchor: null,      // input element (.i_desc)
    tr: null,          // row
    results: [],
    activeIndex: -1,
    lastQuery: "",
    timer: null,
  };

  function ddHide() {
    ddState.open = false;
    ddState.anchor = null;
    ddState.tr = null;
    ddState.results = [];
    ddState.activeIndex = -1;
    DD.style.display = "none";
    DD.setAttribute("aria-hidden", "true");
    DD.innerHTML = "";
  }

  function ddReposition() {
    if (!ddState.open || !ddState.anchor) return;
    const rect = ddState.anchor.getBoundingClientRect();
    const left = rect.left + window.scrollX;
    const top = rect.bottom + window.scrollY + 6;
    const width = rect.width;

    DD.style.left = `${left}px`;
    DD.style.top = `${top}px`;
    DD.style.width = `${width}px`;
  }

  function ddSetActive(idx) {
    const items = Array.from(DD.querySelectorAll(".suggestItem[data-act='pickSuggest']"));
    items.forEach((el, i) => el.classList.toggle("active", i === idx));
    ddState.activeIndex = idx;
    const active = items[idx];
    if (active) active.scrollIntoView({ block: "nearest" });
  }

  function ddRender(anchorInput, tr, results) {
    ddState.open = true;
    ddState.anchor = anchorInput;
    ddState.tr = tr;
    ddState.results = Array.isArray(results) ? results : [];
    ddState.activeIndex = ddState.results.length ? 0 : -1;

    if (!ddState.results.length) {
      DD.innerHTML = `<div class="suggestItem"><div class="suggestMeta">No matches.</div></div>`;
    } else {
      DD.innerHTML = ddState.results.map((r) => {
        const itemNo = esc(r.itemNo || "");
        const description = esc(r.description || "");
        return `
          <div class="suggestItem" data-act="pickSuggest" data-itemno="${itemNo}" data-desc="${description}">
            <div class="suggestTop">
              <div class="suggestDesc">${description}</div>
              <div class="suggestCode mono">${itemNo}</div>
            </div>
            <div class="suggestMeta">Enter to select • fills Item No + BPC</div>
          </div>
        `;
      }).join("");
    }

    DD.style.display = "block";
    DD.setAttribute("aria-hidden", "false");
    ddReposition();
    if (ddState.activeIndex >= 0) ddSetActive(ddState.activeIndex);
  }

  async function applyCatalogPick(tr, { itemNo, description }) {
    const itemInput = tr.querySelector(".i_itemNo");
    const descInput = tr.querySelector(".i_desc");

    itemInput.value = itemNo;
    descInput.value = description;

    ddHide();

    await ensureBpcForItem(itemNo);

    tr.querySelector(".i_cases")?.focus();
    maybeAutoAddRowAfterFinishDesc(tr);
  }

  function maybeAutoAddRowAfterFinishDesc(tr) {
    if (!isLastRow(tr)) return;
    if (isRowBlank(tr)) return;
    if (!isRowReadyToCommit(tr)) return;
    addBlankRow();
  }

  async function maybeEnsureBpcAfterItemNo(tr) {
    const itemNo = tr.querySelector(".i_itemNo")?.value?.trim() || "";
    if (!itemNo) return;
    await ensureBpcForItem(itemNo);
  }

  // ====== bulk clear ======
  async function bulkClear() {
    const btn = $("btnBulkClear");
    setBusy(btn, true, "Clearing…");
    setMsg($("clearMsg"), "", true);

    try {
      const palletsText = $("clearText").value.trim();
      if (!palletsText) {
        setMsg($("clearMsg"), "Enter pallets to clear (comma + ranges).", false);
        return;
      }

      const savedBy = ($("clearSavedBy").value.trim() || (ME?.username || "")).trim();
      const { data } = await api("/employee/pallets/clear", { method:"POST", body:{ palletsText, savedBy } });

      if (!data?.ok) {
        setMsg($("clearMsg"), data?.error || "CLEAR_FAILED", false);
        return;
      }

      const results = Array.isArray(data.results) ? data.results : [];
      const tbody = $("clearTbody");

      if (!results.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="muted">No results returned.</td></tr>`;
        setMsg($("clearMsg"), "Clear completed (no results).", true);
        return;
      }

      tbody.innerHTML = results.map(r => {
        const ok = !!r.ok;
        return `
          <tr>
            <td class="right mono">${esc(r.pallet)}</td>
            <td class="${ok ? "ok" : "err"}">${ok ? "OK" : "FAILED"}</td>
            <td class="right mono">${ok ? esc(r.rev ?? "") : ""}</td>
            <td class="muted">${ok ? esc(r.savedAt ?? "") : ""}</td>
            <td>${ok ? esc(r.savedBy ?? "") : ""}</td>
            <td class="muted">${ok ? "" : esc(r.error || r.detail || "")}</td>
          </tr>
        `;
      }).join("");

      const okCount = results.filter(x => x.ok).length;
      setMsg($("clearMsg"), `Done. OK: ${okCount}/${results.length}`, true);
    } finally {
      setBusy(btn, false);
    }
  }

  // ====== events ======
  $("btnLogout").addEventListener("click", async () => {
    await api("/auth/logout", { method:"POST" });
    location.href = "./index.html";
  });

  $("btnRefreshConfig").addEventListener("click", async () => {
    await loadConfig();
    setMsg($("palletMsg"), "Refreshed config.", true);
  });

  $("btnLoadPallet").addEventListener("click", loadPallet);
  $("btnSavePallet").addEventListener("click", savePallet);

  $("btnAddRow").addEventListener("click", () => {
    if (!CURRENT_PALLET) return setMsg($("palletMsg"), "Load a pallet first.", false);
    addBlankRow();
  });

  $("btnClearRows").addEventListener("click", () => {
    if (!CURRENT_PALLET) return setMsg($("palletMsg"), "Load a pallet first.", false);
    renderItems([{ itemNo:"", description:"", bpc: 1, cases: 0, each: 0 }]);
  });

  $("itemsTbody").addEventListener("input", (e) => {
    if (e.target.matches(".i_bpc,.i_cases,.i_each")) updateUnitsSummary();
  });

  // Global dropdown: click-outside closes it
  document.addEventListener("mousedown", (e) => {
    if (DD.style.display === "block") {
      const isDescInput = e.target && e.target.classList && e.target.classList.contains("i_desc");
      if (!DD.contains(e.target) && !isDescInput) ddHide();
    }
  });

  // Keep dropdown aligned while scrolling/resizing
  window.addEventListener("scroll", () => ddReposition(), true);
  window.addEventListener("resize", () => ddReposition());

  // Table clicks: delete row or pick suggestion
  $("itemsTbody").addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if (btn) {
      const act = btn.getAttribute("data-act");
      if (act === "delRow") {
        ddHide();
        const tr = btn.closest("tr[data-idx]");
        if (!tr) return;
        tr.remove();
        updateUnitsSummary();
        const items = getItemsFromUI();
        renderItems(items.length ? items : [{ itemNo:"", description:"", bpc: 1, cases: 0, each: 0 }]);
        return;
      }
    }

    const pick = e.target.closest(".suggestItem");
    if (pick && pick.getAttribute("data-act") === "pickSuggest") {
      const tr = ddState.tr;
      if (!tr) return;
      const itemNo = pick.getAttribute("data-itemno") || "";
      const description = pick.getAttribute("data-desc") || "";
      await applyCatalogPick(tr, { itemNo, description });
    }
  });

  // Debounced catalog search on description input (global dropdown)
  $("itemsTbody").addEventListener("input", (e) => {
    const descInput = e.target;
    if (!descInput.matches(".i_desc")) return;

    const tr = descInput.closest("tr[data-idx]");
    if (!tr) return;

    const q = descInput.value.trim();

    ddState.anchor = descInput;
    ddState.tr = tr;

    if (ddState.timer) clearTimeout(ddState.timer);

    if (q.length < 2) {
      ddHide();
      return;
    }

    ddState.timer = setTimeout(async () => {
      try {
        const results = await searchCatalog(q);
        ddRender(descInput, tr, results);
      } catch {
        ddHide();
      }
    }, 180);
  });

  // Keyboard nav for dropdown + finish typing behavior
  $("itemsTbody").addEventListener("keydown", async (e) => {
    const tr = e.target.closest("tr[data-idx]");
    if (!tr) return;

    if (e.target.matches(".i_desc")) {
      const isOpen = DD.style.display === "block" && ddState.tr === tr;
      const n = (ddState.results || []).length;

      if (isOpen && (e.key === "ArrowDown" || e.key === "ArrowUp")) {
        e.preventDefault();
        if (!n) return;
        const next = e.key === "ArrowDown"
          ? Math.min((ddState.activeIndex ?? 0) + 1, n - 1)
          : Math.max((ddState.activeIndex ?? 0) - 1, 0);
        ddSetActive(next);
        return;
      }

      if (e.key === "Enter") {
        e.preventDefault();
        if (isOpen && n) {
          const idx = Math.max(0, Math.min(ddState.activeIndex ?? 0, n - 1));
          const r = ddState.results[idx];
          if (r) await applyCatalogPick(tr, { itemNo: r.itemNo, description: r.description });
          return;
        }
        // Enter without open dropdown => treat as "finished typing"
        ddHide();
        maybeAutoAddRowAfterFinishDesc(tr);
        return;
      }

      if (isOpen && e.key === "Escape") {
        e.preventDefault();
        ddHide();
        return;
      }
    }
  });

  // Blur behavior
  $("itemsTbody").addEventListener("blur", (e) => {
    const tr = e.target.closest("tr[data-idx]");
    if (!tr) return;

    if (e.target.matches(".i_desc")) {
      // allow suggestion click to register
      setTimeout(() => {
        const isOpen = DD.style.display === "block" && ddState.tr === tr;
        if (!isOpen) maybeAutoAddRowAfterFinishDesc(tr);
      }, 120);
    }

    if (e.target.matches(".i_itemNo")) {
      setTimeout(() => {
        if (!isRowBlank(tr)) maybeEnsureBpcAfterItemNo(tr);
      }, 0);
    }
  }, true);

  // ====== bulk clear events ======
  $("btnBulkClear").addEventListener("click", bulkClear);
  $("btnClearBulkBox").addEventListener("click", () => {
    $("clearText").value = "";
    $("clearSavedBy").value = "";
    setMsg($("clearMsg"), "", true);
  });

  // ====== boot ======
  (async () => {
    ME = await guardEmployee();
    if (!ME) return;
    await loadConfig();
    $("savedBy").value = ME.username || "";
    $("clearSavedBy").value = ME.username || "";
  })();
</script>
</body>
</html>
