<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Warehouse — Manager</title>

  <!-- XLSX parser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#f6f7fb; color:#111; }
    header { background:#0b1b3a; color:#fff; padding:14px 18px; }
    header .top { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    header h1 { margin:0; font-size:18px; }
    header .me { font-size:13px; opacity:.92; }
    header button { background:#ffffff22; color:#fff; border:1px solid #ffffff33; padding:8px 10px; border-radius:10px; cursor:pointer; }

    main { max-width: 1100px; margin: 18px auto; padding: 0 16px 28px; display:grid; gap:16px; }

    .card { background:#fff; border-radius:14px; padding:14px; box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    h2 { margin:0 0 10px; font-size:16px; }
    .muted { color:#555; font-size:13px; line-height:1.35; }
    .msg { margin-top:10px; font-size:13px; }
    .err { color:#b42318; }
    .ok { color:#067647; }

    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }

    label { display:block; font-size:13px; margin:10px 0 6px; color:#222; }
    input, select { width:100%; padding:10px 12px; border:1px solid #d6d8e0; border-radius:10px; font-size:14px; }

    button.primary { background:#1f6feb; color:#fff; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; }
    button.ghost { background:transparent; color:#1f6feb; border:1px solid #cfe0ff; padding:10px 12px; border-radius:10px; cursor:pointer; }
    button.small { padding:6px 10px; border-radius:9px; font-size:13px; }

    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid #eceef3; font-size:13px; vertical-align:top; }
    th { font-size:12px; color:#555; text-transform: uppercase; letter-spacing:.03em; }

    .pill { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid #e1e4ee; }
    .pill.active { background:#ecfdf3; border-color:#abefc6; color:#067647; }
    .pill.disabled { background:#fff1f3; border-color:#fecdd6; color:#b42318; }

    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex:1; }
    .nowrap { white-space:nowrap; }
    .mono { font-family: ui-monospace, monospace; }
    .tiny th, .tiny td { padding:8px 6px; font-size:12px; }
  </style>
</head>
<body>

<header>
  <div class="top">
    <div>
      <h1>Manager Dashboard</h1>
      <div class="me" id="meLine">Loading session…</div>
    </div>
    <div class="actions">
      <button id="btnRefresh">Refresh</button>
      <button id="btnLogout">Logout</button>
    </div>
  </div>
</header>

<main>

  <!-- ================== CATALOG UPLOAD ================== -->
  <div class="card">
    <h2>Catalog Upload</h2>
    <div class="muted">
      Upload an Excel <span class="mono">.xlsx</span> to replace the Google Sheet tab named <b>catalog</b>.
    </div>

    <div class="grid" style="margin-top:12px;">
      <div>
        <label>Select .xlsx file</label>
        <input id="catFile" type="file" accept=".xlsx" />
      </div>
      <div>
        <label>Catalog Version (optional)</label>
        <input id="catVersion" placeholder="Leave blank to use timestamp" />
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="ghost" id="btnCatPreview" type="button">Preview</button>

      <button class="primary" id="btnCatUpload" type="button">
        <span id="catUploadLabel">Upload (Replace)</span>
        <span id="catSpinner" style="display:none; margin-left:8px;">⏳</span>
      </button>

      <div id="catProg" class="muted" style="margin-left:auto; font-size:13px;"></div>
    </div>

    <div id="catMsg" class="msg"></div>

    <div style="overflow:auto; margin-top:10px; max-height:260px;">
      <table class="tiny">
        <thead id="catHead"></thead>
        <tbody id="catBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ================== USERS ================== -->
  <div class="card">
    <h2>Users</h2>

    <div class="row" style="margin-top:12px;">
      <input id="filter" placeholder="Filter by username, userId, role, status…" />
      <button class="ghost" id="btnClearFilter">Clear</button>
    </div>

    <div id="usersMsg" class="msg"></div>

    <div style="overflow:auto; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Role</th>
            <th>Status</th>
            <th>Must Change Pw</th>
            <th>Created</th>
            <th>Last Login</th>
            <th class="nowrap">Actions</th>
          </tr>
        </thead>
        <tbody id="usersTbody">
          <tr><td colspan="7" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</main>

<script>
const API_BASE = "https://queensims.anthonycr2001.workers.dev";

const $ = id => document.getElementById(id);
const setMsg = (el, text, ok=false) => {
  el.textContent = text || "";
  el.className = "msg " + (ok ? "ok" : "err");
};

async function api(path, {method="GET", body=null}={}) {
  const res = await fetch(API_BASE + path, {
    method,
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body: body ? JSON.stringify(body) : null
  });
  const data = await res.json().catch(()=>({}));
  return {status:res.status, data};
}

/* ================= AUTH GUARD ================= */
(async()=>{
  const {data} = await api("/me");
  if(!data?.ok || data.me.role !== "manager"){
    location.href="./index.html";
    return;
  }
  $("meLine").textContent = `Signed in as ${data.me.username} (${data.me.role})`;
})();

/* ================= CATALOG ================= */

let CATALOG_ROWS = [];
const HEADERS = ["Store","Item No.","Description","Subdep","Pack Size","Qty On Hand","Qty On PO","Avg Cost","Base Price","Gross M","Gross M %","Tax No.","Vendor","Track Item","Sales Rep"];

function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  })[m]);
}

async function parseFile(){
  const file = $("catFile").files?.[0];
  if(!file){ setMsg($("catMsg"),"Choose a file.",false); return false; }

  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf,{type:"array"});
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const aoa = XLSX.utils.sheet_to_json(sheet,{header:1,defval:""});

  CATALOG_ROWS = aoa.slice(1).map(r=>r.slice(0,15));
  renderPreview();
  setMsg($("catMsg"),`Parsed ${CATALOG_ROWS.length} rows.`,true);
  return true;
}

function renderPreview(){
  $("catHead").innerHTML = `<tr>${HEADERS.map(h=>`<th>${h}</th>`).join("")}</tr>`;
  $("catBody").innerHTML = CATALOG_ROWS.slice(0,25).map(r=>`<tr>${r.map(c=>`<td>${esc(c)}</td>`).join("")}</tr>`).join("");
}

function setUploading(on,text=""){
  $("btnCatUpload").disabled = on;
  $("catSpinner").style.display = on?"inline":"none";
  $("catUploadLabel").textContent = on?"Uploading…":"Upload (Replace)";
  $("catProg").textContent = text;
}

$("btnCatPreview").onclick = parseFile;

$("btnCatUpload").onclick = async ()=>{
  if(!CATALOG_ROWS.length){
    const ok = await parseFile();
    if(!ok) return;
  }

  setUploading(true,`Uploading ${CATALOG_ROWS.length} rows…`);

  try{
    const {data} = await api("/manager/catalog/upload",{
      method:"POST",
      body:{ rows:CATALOG_ROWS, catalogVersion:$("catVersion").value.trim()||undefined }
    });

    if(!data?.ok){
      setUploading(false,"Failed");
      setMsg($("catMsg"),data?.error||"Upload failed",false);
      return;
    }

    setUploading(false,`Done (${data.rowCount})`);
    setMsg($("catMsg"),`✅ Uploaded ${data.rowCount} rows.`,true);
  }catch(e){
    setUploading(false,"Failed");
    setMsg($("catMsg"),"Upload failed",false);
  }
};

/* ================= USERS ================= */

let USERS=[];

async function loadUsers(){
  const {data}=await api("/manager/users");
  if(!data?.ok){
    $("usersTbody").innerHTML=`<tr><td colspan="7">Failed</td></tr>`;
    return;
  }
  USERS=data.users||data.list||[];
  renderUsers();
}

function renderUsers(){
  $("usersTbody").innerHTML=USERS.map(u=>`
    <tr>
      <td><b>${esc(u.username)}</b><div class="muted">${esc(u.userId)}</div></td>
      <td>${esc(u.role)}</td>
      <td>${esc(u.status)}</td>
      <td>${esc(u.mustChangePassword)}</td>
      <td>${esc(u.createdAt||"")}</td>
      <td>${esc(u.lastLoginAt||"")}</td>
      <td></td>
    </tr>
  `).join("");
}

$("btnRefresh").onclick=loadUsers;
$("btnLogout").onclick=async()=>{
  await api("/auth/logout",{method:"POST"});
  location.href="./index.html";
};

loadUsers();
</script>

</body>
</html>
