<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Warehouse — Login</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7fb; }
    .wrap { max-width: 440px; margin: 64px auto; padding: 20px; }
    .card { background: #fff; border-radius: 14px; padding: 18px; box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .muted { color: #555; font-size: 13px; line-height: 1.35; }
    label { display: block; font-size: 13px; margin: 14px 0 6px; color: #222; }
    input { width: 100%; padding: 10px 12px; border: 1px solid #d6d8e0; border-radius: 10px; font-size: 14px; }
    button { width: 100%; margin-top: 14px; padding: 10px 12px; border: 0; border-radius: 10px; font-size: 14px; cursor: pointer; }
    button.primary { background: #1f6feb; color: white; }
    button.ghost { background: transparent; color: #1f6feb; border: 1px solid #cfe0ff; }
    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }
    .msg { margin-top: 12px; font-size: 13px; }
    .err { color: #b42318; }
    .ok { color: #067647; }
    .hidden { display:none !important; }

    /* modal */
    .modalBack {
      position: fixed; inset: 0; background: rgba(0,0,0,.35);
      display: flex; align-items: center; justify-content: center; padding: 18px;
    }
    .modal {
      width: min(520px, 100%); background: white; border-radius: 14px;
      padding: 16px; box-shadow: 0 12px 36px rgba(0,0,0,.2);
    }
    .modal h2 { margin: 0 0 8px; font-size: 18px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Warehouse Login</h1>
      <div class="muted">Sign in to access pallets & manager tools.</div>

      <label>Username</label>
      <input id="username" autocomplete="username" />

      <label>Password</label>
      <input id="password" type="password" autocomplete="current-password" />

      <button class="primary" id="btnLogin">Sign in</button>

      <div class="row">
        <button class="ghost" id="btnMe" type="button">Check session</button>
        <button class="ghost" id="btnLogout" type="button">Logout</button>
      </div>

      <div id="msg" class="msg"></div>
    </div>
  </div>

  <!-- Must Change Password Modal -->
  <div id="mcpBack" class="modalBack hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <h2>Password update required</h2>
      <div class="muted">You must change your password before using the app.</div>

      <label>Old password</label>
      <input id="oldPw" type="password" autocomplete="current-password" />

      <label>New password</label>
      <input id="newPw" type="password" autocomplete="new-password" />

      <label>Confirm new password</label>
      <input id="newPw2" type="password" autocomplete="new-password" />

      <button class="primary" id="btnChangePw">Save new password</button>
      <button class="ghost" id="btnMcpLogout" type="button">Logout</button>

      <div id="mcpMsg" class="msg"></div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const API_BASE = "https://queensims.anthonycr2001.workers.dev"; // <-- change if needed

  // ====== helpers ======
  const $ = (id) => document.getElementById(id);
  const msg = (text, ok=false) => { $("msg").textContent = text || ""; $("msg").className = "msg " + (ok ? "ok" : "err"); };
  const mcpMsg = (text, ok=false) => { $("mcpMsg").textContent = text || ""; $("mcpMsg").className = "msg " + (ok ? "ok" : "err"); };

  async function api(path, { method="GET", body=null } = {}) {
    const url = API_BASE + path;
    const opts = {
      method,
      credentials: "include",
      headers: { "Content-Type": "application/json" },
    };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(url, opts);
    const data = await res.json().catch(() => ({}));
    return { status: res.status, data };
  }

  function openMcpModal() {
    $("mcpBack").classList.remove("hidden");
    $("oldPw").value = "";
    $("newPw").value = "";
    $("newPw2").value = "";
    mcpMsg("");
  }
  function closeMcpModal() { $("mcpBack").classList.add("hidden"); }

  async function checkSessionAndRoute() {
    const { data } = await api("/me");
    if (!data?.ok) return;

    // Must-change-password? force modal and stop.
    if (String(data.me?.mustChangePassword || "").toLowerCase() === "true") {
      openMcpModal();
      return;
    }

    // Route by role
    const role = String(data.me?.role || "").toLowerCase();
    if (role === "manager") {
      // next step: manager dashboard page
      location.href = "./manager.html";
    } else {
      // next step: employee pallet page
      location.href = "./employee.html";
    }
  }

  // ====== actions ======
  $("btnLogin").addEventListener("click", async () => {
    msg("");
    const username = $("username").value.trim();
    const password = $("password").value;

    if (!username || !password) return msg("Username + password required.");

    const { data } = await api("/auth/login", { method:"POST", body:{ username, password } });

    if (!data?.ok) return msg(data?.error || "LOGIN_FAILED");

    // If they must change, show modal (don’t redirect yet)
    if (String(data.me?.mustChangePassword || "").toLowerCase() === "true") {
      msg("Signed in. Password change required.", true);
      openMcpModal();
      return;
    }

    msg("Signed in.", true);
    // Route based on role
    await checkSessionAndRoute();
  });

  $("btnMe").addEventListener("click", async () => {
    msg("");
    const { data } = await api("/me");
    if (!data?.ok) return msg("No active session.");
    msg(`Session OK: ${data.me.username} (${data.me.role})`, true);

    if (String(data.me.mustChangePassword || "").toLowerCase() === "true") {
      openMcpModal();
    }
  });

  $("btnLogout").addEventListener("click", async () => {
    await api("/auth/logout", { method:"POST" });
    msg("Logged out.", true);
  });

  $("btnMcpLogout").addEventListener("click", async () => {
    await api("/auth/logout", { method:"POST" });
    closeMcpModal();
    msg("Logged out.", true);
  });

  $("btnChangePw").addEventListener("click", async () => {
    mcpMsg("");
    const oldPassword = $("oldPw").value;
    const newPassword = $("newPw").value;
    const newPassword2 = $("newPw2").value;

    if (!oldPassword || !newPassword) return mcpMsg("Old + new password required.");
    if (newPassword !== newPassword2) return mcpMsg("New passwords do not match.");

    const { data } = await api("/auth/change-password", { method:"POST", body:{ oldPassword, newPassword } });

    if (!data?.ok) return mcpMsg(data?.error || "CHANGE_FAILED");

    mcpMsg("Password updated. Redirecting…", true);
    closeMcpModal();

    // Route based on role now that mustChangePassword should be false
    await checkSessionAndRoute();
  });

  // Auto-check on load (if user already has cookie)
  checkSessionAndRoute();
</script>
</body>
</html>
